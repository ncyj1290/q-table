<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itwillbs.qtable.mapper.admin.AdminMapper">

	<!-- 매장 회원 목록 리스트 조회 -->
    <select id="findStoreMembers">
        SELECT
               m.member_idx,
               s.store_name,
               m.member_id,
               m.email,
               m.signup_date,
               c.code_label AS member_status
          FROM member m
          JOIN store s ON m.member_idx = s.member_idx
          JOIN common_code c ON m.member_status = c.code
         WHERE m.member_type = 'mtype_03'
           AND c.group_code = 'member_status'
    </select>
    
    <!-- 회원 / 매장 상세페이지 조회-->
    <select id="findMemberDetail">
        SELECT
        	   m.member_idx,
        	   m.member_id,
        	   m.birth,
        	   m.address,
        	   m.address_detail,
        	   m.member_name,
        	   m.email,
       	       m.signup_date,
       	       m.q_money,
       	       m.leave_at,
       	       m.member_type,
       	       m.business_reg_no,
        	   c.code_label AS member_status,
        	   s.store_name,
        	   s.store_seat,
        	   s.deposit,
        	   s.account_number,
        	   c1.code_label AS open_time,
        	   c2.code_label AS close_time
    	  FROM member m 
     LEFT JOIN store s ON m.member_idx = s.member_idx
     LEFT JOIN common_code c ON m.member_status = c.code
     LEFT JOIN common_code c1 ON s.open_time = c1.code
     LEFT JOIN common_code c2 ON s.close_time = c2.code
         WHERE m.member_idx = #{member_idx}
    </select>
    
    <!-- 매장 입점 신청 목록 리스트 조회-->
    <select id="findEntryStores">
      SELECT
             s.store_idx,
             s.member_idx,
             s.store_name,
             m.member_id,
             c.code_label AS store_status,
             s.processed_at,
             s.applied_at
        FROM store s 
        JOIN member m ON s.member_idx = m.member_idx
        JOIN common_code c ON s.store_status = c.code
       WHERE c.group_code = 'store_status'
    ORDER BY s.store_idx DESC
    </select>
    
    <!-- 회원 결제 목록 리스트 -->
    <select id="findPaymentListMembers">
	    SELECT
		   	   p.payment_idx,
	           m.member_idx,
	           m.member_id,
	           m.member_name,
	           p.payment_amount,
	           p.payment_date,
	           c.code_label AS pay_status,
	           c1.code_label AS pay_way,
	           c2.code_label AS pay_type
	      FROM payment p 
	 LEFT JOIN member m ON p.member_idx = m.member_idx
	 LEFT JOIN common_code c ON p.pay_status = c.code
	 LEFT JOIN common_code c1 ON p.pay_way = c1.code
	 LEFT JOIN common_code c2 ON p.pay_type = c2.code
    </select>
    
    <!-- 매장 결제 목록 리스트 -->
    <select id="findPaymentListStores">
	    SELECT
		   	   p.payment_idx,
		   	   s.store_idx,
	           s.store_name,
	           m.member_id,
	           m.member_name,
	           p.payment_amount,
	           p.payment_date,
	           c.code_label AS pay_status,
	           c1.code_label AS pay_way,
	           c2.code_label AS pay_type
	      FROM payment p 
	 LEFT JOIN member m ON p.member_idx = m.member_idx
	 LEFT JOIN reservation r ON p.reference_idx = r.reserve_idx
	 LEFT JOIN store s ON r.store_idx = s.store_idx
	 LEFT JOIN common_code c ON p.pay_status = c.code
	 LEFT JOIN common_code c1 ON p.pay_way = c1.code
	 LEFT JOIN common_code c2 ON p.pay_type = c2.code
         WHERE p.pay_type IN ('pyus_02', 'pyus_03') -- 예약금 결제, 현장 결제
    </select>
    
    <!-- 매장 정산 리스트 -->
    <select id="findJeongsanList">
		SELECT
			   j.jeongsan_idx,
		       j.jeongsan_amount,
		       c.code_label AS calculate_result,
		       j.requested_at,
		       j.processed_at,
		       s.store_name,
		       s.account_number,
		       m.member_id
		  FROM jeongsan j 
	 LEFT JOIN member m ON j.member_idx = m.member_idx
	 LEFT JOIN store s ON j.member_idx = s.member_idx
	 LEFT JOIN common_code c ON j.calculate_result = c.code
		 WHERE member_type = "mtype_03"
    </select>
    
    <!-- 매장 정산 상세 내용 -->
    <select id="findJeongsanDetail">
	     SELECT
	            j.jeongsan_idx,
	            j.member_idx,
	            j.jeongsan_amount,
		        j.calculate_result, 
		        c.code_label AS calculate_result_name,
	            j.requested_at,
	            j.processed_at,
	            j.rejection_reason,
	            m.member_id,
	            s.store_name
	       FROM jeongsan j
	       JOIN member m ON j.member_idx = m.member_idx
	  LEFT JOIN store s ON j.member_idx = s.member_idx
	  LEFT JOIN common_code c ON j.calculate_result = c.code AND c.group_code = 'calculate_result'
	      WHERE j.jeongsan_idx = #{jeongsan_idx}
    </select>
    
    <!-- 매장 구독 리스트 -->
    <select id="findSubscribeList">
		SELECT ss.subscribe_idx,
			   ss.subscribe_start,
		       ss.subscribe_end,
		       s.store_idx,
		       s.store_name,
		       m.member_idx,
		       m.member_id,
		       DATEDIFF(subscribe_end, CURDATE()) AS remaining_days
		  FROM subscribe ss 
	 LEFT JOIN store s ON ss.store_idx = s.store_idx
	 LEFT JOIN member m ON m.member_idx = s.member_idx;
    </select>

    
    
</mapper>
