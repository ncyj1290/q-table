<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.qtable.mapper.mypage.ReservationListMapper">
	
	<!--예약 관련 select-->
	<select id="getMyReservationList" resultType="map">
		SELECT
				 s.store_idx
			   , s.store_name
			   , s.store_content
			   , s.store_phone
		       , s.full_address
		       , rv.reserve_idx
		       , rv.person_count
		       , rv.reserve_time
		       , 
	   (SELECT 	 image_url
		  FROM   image
	     WHERE   target_type = 'imguse_01'
	       AND   target_idx = s.store_idx LIMIT 1) AS store_img,
	   (SELECT   COALESCE(ROUND(AVG(r.score), 2), 0) 
   		  FROM   review r 
  		 WHERE   r.store_idx = s.store_idx) AS avgScore,
	   			 CONCAT(rv.reserve_date, ' ', rv.reserve_time) AS reserve_dt
		  FROM 	 reservation rv
				 JOIN store s ON rv.store_idx = s.store_idx
		 WHERE 	 rv.member_idx = #{member_idx}
	<if test="reserve_result != null and reserve_result != ''">
    	   AND 	 rv.reserve_result = #{reserve_result}
    </if>
	  ORDER BY 	 rv.created_at DESC
	</select>	
	
	<!-- 예약 상태 업데이트 -->
   <update id="updateReservationStatus">
   	  UPDATE reservation
    	 SET reserve_result = #{reserve_result}
       WHERE reserve_idx = #{reserve_idx}
         AND member_idx = #{member_idx}
   </update>
   
	<!--예약 결제정보 한 건 조회 -->
	 <select id="findPaymentByMemberIdx"  resultType="map">
	  SELECT   payment_idx
	  		 , member_idx
	  		 , payment_amount
	  		 , pay_type
	    FROM   payment
	   WHERE   member_idx = #{member_idx}
	     AND   reference_idx = #{reserve_idx}
	</select>
	
	<!--멤버 Q머니 환불-->
	<update id="refundQmoney" parameterType="map">
	  UPDATE member
	     SET q_money = q_money + #{amount}
	   WHERE member_idx = #{member_idx}
	</update>
	
	<!--결제 상태 업데이트-->
	<update id="updatePaymentType" parameterType="map">
	  UPDATE payment
  		 SET pay_type = #{pay_type},
  		 	 payment_date = #{payment_date}
 	   WHERE payment_idx = #{payment_idx}
	</update>
	
	<!--qmoney-->
	<select id="selectQmoneyByMemberIdx">
	    SELECT q_money 
	      FROM member 
	     WHERE member_idx = #{member_idx}
	</select>

	<!--  하단 광고  -->
	<select id="selectRandomStores">
	  SELECT * FROM store
	  ORDER BY RAND()
	  LIMIT 10
	</select>
	
	
	
	
</mapper>