<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"https://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.itwillbs.qtable.mapper.search.SearchKeywordListMapper">
	<select id="selectSeatCntPriceRange">
		SELECT * 
		  FROM common_code
		 WHERE group_code = #{group_code}
	</select>
	
	<select id="getRegionLargeCategory">
		SELECT code, code_label
		  FROM common_code
		 WHERE group_code = 'location'
		   AND parent_code is null;
	</select>
	
	<select id="getSubLocation">
		SELECT * 
		  FROM common_code
		 WHERE group_code = 'location'
		   and parent_code is not null 
	  ORDER BY common_idx;
	</select>
	
	<select id="getPerCnt">
		select * 
		  from common_code
		 where group_code = 'person_count';
	</select>
	
	<select id="getTime">
		select * 
		  from common_code
		 where group_code = 'time';
	</select>
	
	<select id="getResult">
		WITH user_scrap AS (
			SELECT store_idx 
			  FROM scrap 
		     WHERE member_idx = #{vo.member_idx} 
		)
		SELECT s.store_idx
			 , s.store_name
		     , s.sido
		     , s.sigungu
		     , s.price_avg price
		     , s.store_content content
		     , s.is_24hour
		     , s.is_accept
		     , cOpen.code_label 'open_time'
		     , cClose.code_label 'close_time'
		     , COUNT(r.content) reviewCnt
		     , IFNULL(ROUND(SUM(r.score)/COUNT(r.review_idx),1),0) score
		     , i.image_url
		     , GROUP_CONCAT(distinct(cHoliday.code_label) ORDER BY cHoliday.code) 'holiday'
			 , CASE WHEN us.store_idx is not null then 1 
                    ELSE 0
			      END AS is_scrapped
		FROM store s
		JOIN common_code cOpen ON s.open_time = cOpen.code
		JOIN common_code cClose ON s.close_time = cClose.code 
		LEFT OUTER JOIN review r ON s.store_idx = r.store_idx 
		LEFT OUTER JOIN image i ON s.store_idx = i.target_idx 
		LEFT OUTER JOIN store_holiday h ON s.store_idx = h.store_idx 
		LEFT OUTER JOIN common_code cHoliday ON h.store_holiday = cHoliday.code 
		LEFT OUTER JOIN user_scrap us ON s.store_idx = us.store_idx
		WHERE i.target_type = 'imguse_01'
		GROUP BY s.store_idx
		       , s.store_name
		       , s.sido
		       , i.image_url
		       , sigungu
		       , price
		       , is_24hour
		       , store_content
		       , cOpen.code_label
		       , cClose.code_label
  	    ORDER BY ${vo.sort};
	</select>	
	
	
</mapper>